name: CI

on:
  push:
    branches: [ main ]

jobs:

  setup-python:
    runs-on: self-hosted
    strategy:
      matrix:
        python-version: [3.8, 3.9]
    steps:
      - uses: actions/checkout@v2
      - name: Setup python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
            python-version: ${{ matrix.python-version }}
      - name: Install deps
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

  codestyle:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - name: Install deps
        run: pip install flake8
      - name: Check codestyle
        run: python3 -m flake8 ./ --ignore=F401,E402

  test:
    runs-on: self-hosted
    needs: [setup-python, codestyle]
    steps:
      - uses: actions/checkout@v2
      - name: Install deps
        run: |
          pip install -e '.[test]'
          python3 -m coverage run -m pytest
          python3 -m coverage report

  build_and_pub:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Login to docker.io
        run: echo ${{ secrets.DOCKER_PWD }} | sudo docker login -u ${{ secrets.DOCKER_LOG }} --password-stdin
      - uses: actions/checkout@master
      - name: Build image
        run: sudo docker build -t flask_app:v0.1 -f Dockerfile .
      - name: Tag
        run: sudo docker tag flask_app:v0.1 rburtsev/rburtsev
      - name: Push image to dockerhub
        run: sudo docker push rburtsev/rburtsev
      - name: Docker run
        run: sudo docker run -d -p 8080:5000 --name test rburtsev/rburtsev
  


